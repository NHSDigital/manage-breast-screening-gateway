name: "Stage 2: Test"

on:
  workflow_call:

permissions:
  contents: read
  security-events: write

jobs:
  test-unit:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Read tool versions
        id: tool-versions
        run: |
          echo "python=$(awk '/^python / {print $2}' .tool-versions)" >> "$GITHUB_OUTPUT"
          echo "uv=$(awk '/^uv / {print $2}' .tool-versions)" >> "$GITHUB_OUTPUT"

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: ${{ steps.tool-versions.outputs.python }}

      - name: Install uv
        uses: astral-sh/setup-uv@887a942a15af3a7626099df99e897a18d9e5ab3a # v5.1.0
        with:
          version: ${{ steps.tool-versions.outputs.uv }}
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run tests
        run: uv run pytest

      - name: Upload coverage reports
        uses: codecov/codecov-action@cb6530fbecd68d5f1ee7a3dcd113450ea8d5d6d4 # v5.1.2
        if: always()
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  test-lint:
    name: Lint and type checking
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Read tool versions
        id: tool-versions
        run: |
          echo "python=$(awk '/^python / {print $2}' .tool-versions)" >> "$GITHUB_OUTPUT"
          echo "uv=$(awk '/^uv / {print $2}' .tool-versions)" >> "$GITHUB_OUTPUT"

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: ${{ steps.tool-versions.outputs.python }}

      - name: Install uv
        uses: astral-sh/setup-uv@887a942a15af3a7626099df99e897a18d9e5ab3a # v5.1.0
        with:
          version: ${{ steps.tool-versions.outputs.uv }}
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run ruff check (SARIF)
        id: ruff
        run: |
          # Run ruff and capture output. If it fails or is empty, provide a valid empty SARIF.
          if uv run ruff check . --format sarif > ruff-results.sarif; then
            echo "Results generated."
          else
            echo "Ruff failed or returned non-zero. Checking if file is valid..."
          fi

          # If the file is empty or missing, create a valid empty SARIF object
          if [ ! -s ruff-results.sarif ]; then
            echo '{"version": "2.1.0", "$schema": "https://json.schemastore.org/sarif-2.1.0-rtm.5.json", "runs": [{"tool": {"driver": {"name": "Ruff"}}, "results": []}]}' > ruff-results.sarif
          fi
        continue-on-error: true

      - name: Upload ruff SARIF
        uses: github/codeql-action/upload-sarif@8c78abb9b62512e3c45dea6559ffd924ed8549c8 # v3.28.0
        with:
          sarif_file: ruff-results.sarif
        if: always()

      - name: Run ruff format check
        run: uv run ruff format --check .

      - name: Run pyright
        run: uv run pyright
